name: ğŸš€ 350  x  2  private (with Monitor x All Key)

on:
  workflow_dispatch:
  #schedule:
    #- cron: '30 */5 * * *'

permissions:
  contents: write
  actions: read

jobs:
  runtime:
    name: ğŸ–¥ï¸ Runner-${{ matrix.runner }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    strategy:
      max-parallel: 5
      fail-fast: false
      matrix:
        runner: [1, 2, 3, 4, 5]
    
    env:
      # ============================================
      # ğŸ”§ CONFIGURATION (EDIT HERE)
      # ============================================
      WALLET_COUNT: '350'
      CONTAINERS_PER_WALLET: '2'
      RUNTIME_HOURS: '5.5'
      REUSE_WALLETS: 'true'
      
      BATCH_SIZE: '200'
      PAUSE_SECONDS: '10'
      PROXY_PORT: '14441'
      
      # Total runners (for display only)
      TOTAL_RUNNERS: '5'
      
    steps:
      # ============================================
      # ğŸ“¦ SETUP
      # ============================================
      
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            proxy/package-lock.json
            scripts/package-lock.json
      
      - name: ğŸ“Š Display Configuration
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ Runner-${{ matrix.runner }} Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Runner ID: ${{ matrix.runner }} of $TOTAL_RUNNERS"
          echo "Trigger: ${{ github.event_name }}"
          echo "Wallet Count: $WALLET_COUNT (shared across all runners)"
          echo "Wallet File: wallets.json (SHARED)"
          echo "Containers/Wallet: $CONTAINERS_PER_WALLET"
          echo "This Runner Total: $(( $WALLET_COUNT * $CONTAINERS_PER_WALLET ))"
          echo "Runtime: $RUNTIME_HOURS hours"
          echo "Reuse Wallets: $REUSE_WALLETS"
          echo ""
          echo "API Keys: ALL keys shared across all runners (load-balanced)"
          echo ""
          echo "System:"
          echo "OS: $(lsb_release -d | cut -f2)"
          echo "RAM: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "Docker: $(docker --version | cut -d' ' -f3 | cut -d',' -f1)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # ğŸ’° WALLET MANAGEMENT (SHARED FILE)
      # ============================================
      
      - name: ğŸ’° Handle Shared Wallets
        id: wallets
        run: |
          WALLET_FILE="wallets.json"
          
          if [[ "$REUSE_WALLETS" == "true" && -f "$WALLET_FILE" ]]; then
            echo "â™»ï¸  Runner-${{ matrix.runner }}: Using shared wallets from repository"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            ACTUAL_COUNT=$(jq '. | length' $WALLET_FILE)
            echo "âœ… Loaded $ACTUAL_COUNT wallets from $WALLET_FILE"
            echo "ğŸ“… Wallets are version controlled (git)"
            echo "ğŸ”„ All runners use the SAME wallets"
            
          else
            echo "ğŸ†• Runner-${{ matrix.runner }}: Generating new shared wallets"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Only runner 1 generates, others wait
            if [[ "${{ matrix.runner }}" == "1" ]]; then
              cd scripts
              [ ! -d "node_modules" ] && npm install
              node crypto-generator.js $WALLET_COUNT
              mv wallets.json ../$WALLET_FILE
              cd ..
              
              ACTUAL_COUNT=$WALLET_COUNT
              echo "âœ… Generated $ACTUAL_COUNT new wallets"
            else
              echo "â³ Waiting for Runner-1 to generate wallets..."
              # Wait for wallets.json to be committed by runner 1
              for i in {1..60}; do
                git pull --rebase origin main || git pull --rebase origin master || true
                if [ -f "$WALLET_FILE" ]; then
                  ACTUAL_COUNT=$(jq '. | length' $WALLET_FILE)
                  echo "âœ… Found $ACTUAL_COUNT wallets from Runner-1"
                  break
                fi
                [ $i -eq 60 ] && echo "âŒ Timeout waiting for wallets" && exit 1
                sleep 5
              done
            fi
          fi
          
          ACTUAL_COUNT=$(jq '. | length' $WALLET_FILE)
          echo "wallet_count=$ACTUAL_COUNT" >> $GITHUB_OUTPUT
          echo "wallet_file=$WALLET_FILE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“‹ Shared Wallet Preview (used by all runners):"
          jq '.[0] | {address: .address, private_key: (.private_key[:10] + "..." + .private_key[-6:])}' $WALLET_FILE
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # ğŸ’¾ COMMIT WALLETS TO REPO (ONLY RUNNER 1)
      # ============================================
      
      - name: ğŸ’¾ Commit Shared Wallets to Repository
        if: always() && matrix.runner == 1
        run: |
          echo "ğŸ’¾ Runner-${{ matrix.runner }}: Saving shared wallets to repository..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          WALLET_FILE="wallets.json"
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ ! -f "$WALLET_FILE" ]; then
            echo "âš ï¸  $WALLET_FILE not found, skipping commit"
            exit 0
          fi
          
          git pull --rebase origin main || git pull --rebase origin master || true
          git add "$WALLET_FILE"
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to $WALLET_FILE"
          else
            WALLET_COUNT=$(jq '. | length' "$WALLET_FILE")
            git commit -m "ğŸ”„ Aut0-upd4te Sh4red W4llets ($WALLET_COUNT w4llets) [run #${{ github.run_number }}]"
            
            MAX_RETRIES=5
            for i in $(seq 1 $MAX_RETRIES); do
              if git push; then
                echo "âœ… Shared wallets committed to repository"
                echo "ğŸ“Š Wallets: $WALLET_COUNT"
                echo "ğŸ“ File: $WALLET_FILE"
                break
              else
                if [ $i -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Push failed, retrying ($i/$MAX_RETRIES)..."
                  sleep $((i * 2))
                  git pull --rebase origin main || git pull --rebase origin master || true
                else
                  echo "âŒ Push failed after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # ğŸ”‘ LOAD API KEYS (SHARED ACROSS ALL RUNNERS)
      # ============================================
      
      - name: ğŸ”‘ Load vLLM Server Config (All Runners Use Same Server)
        id: load_keys
        env:
          VLLM_API_KEY: ${{ secrets.VLLM_API_KEY }}
        run: |
          echo "ğŸ”‘ Loading vLLM server config for Runner-${{ matrix.runner }}..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "ğŸ“Š vLLM Server: Self-hosted"
          echo "ğŸ”„ All runners use SAME vLLM server"
          echo "âš–ï¸  Load balancing: vLLM internal"
          echo "ğŸ” Rate limiting: Disabled (self-hosted)"
          echo ""
          echo "âœ… vLLM config loaded for Runner-${{ matrix.runner }}"
          echo "ğŸ” API Key: ${VLLM_API_KEY:0:15}..."
          echo ""
          
          # Save to output
          echo "vllm_api_key=$VLLM_API_KEY" >> $GITHUB_OUTPUT
          echo "total_keys=1" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # ğŸŒ PROXY SETUP
      # ============================================
      
      - name: ğŸ“¦ Install Proxy Dependencies
        working-directory: ./proxy
        run: |
          echo "ğŸ“¦ Runner-${{ matrix.runner }}: Installing proxy dependencies..."
          npm ci --production
          echo "âœ… Installed"
      
      - name: âš™ï¸ Configure Proxy with vLLM Server
        working-directory: ./proxy
        run: |
          echo "âš™ï¸  Runner-${{ matrix.runner }}: Creating .env file for vLLM server..."
          
          cat > .env << EOF
          VLLM_BASE_URL=${{ secrets.VLLM_BASE_URL || 'http://208.76.40.194:9060' }}
          VLLM_API_KEY=${{ steps.load_keys.outputs.vllm_api_key }}
          MODEL_MAP={"llama3.3:70b-instruct-q4_K_M":"llama3.3:70b-instruct-q4_K_M"}
          PORT=$PROXY_PORT
          RL_MODE=provider_only
          VLLM_RPM_PER_KEY=0
          VLLM_RPS_PER_KEY=0
          PROXY_MIN_TPS=15
          REQUEST_TIMEOUT_MS=60000
          MAX_TOKENS_PER_REQUEST=100
          NODE_ENV=production
          EOF
          
          echo "âœ… Configured with vLLM server (self-hosted)"
          echo "ğŸ’° Token limit: unlimited (self-hosted server)"
      
      - name: ğŸš€ Start Proxy
        working-directory: ./proxy
        run: |
          echo "ğŸš€ Runner-${{ matrix.runner }}: Starting proxy server..."
          
          nohup node index.js > proxy.log 2>&1 &
          echo $! > proxy.pid
          
          echo "â³ Waiting for proxy..."
          for i in {1..30}; do
            if curl -sf http://localhost:$PROXY_PORT/health > /dev/null 2>&1; then
              echo "âœ… Proxy ready on port $PROXY_PORT"
              break
            fi
            [ $i -eq 30 ] && echo "âŒ Failed" && tail -20 proxy.log && exit 1
            sleep 1
          done
      
      - name: ğŸ§ª Test Proxy (Min 2 Pass)
        working-directory: ./proxy
        env:
          PROXY_PORT: ${{ env.PROXY_PORT }}
        run: |
          echo "ğŸ§ª Runner-${{ matrix.runner }}: Running automated proxy tests..."
          chmod +x test_proxy.sh
          
          # 1. Jalankan script tapi jangan langsung exit kalau error (set +e)
          # 2. Simpan output ke file log.txt dan tampilkan juga ke layar (tee)
          set +e
          ./test_proxy.sh | tee proxy_test.log
          SCRIPT_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          echo ""
          echo "ğŸ“Š Checking test results..."
          
          # 3. Ambil angka jumlah test yang lulus dari log
          # Format di log: "Tests passed: 3 / 5" -> Ambil angka "3" (kolom ke-3)
          PASS_COUNT=$(grep "Tests passed:" proxy_test.log | awk '{print $3}')
          
          # Default ke 0 jika tidak ketemu
          if [ -z "$PASS_COUNT" ]; then PASS_COUNT=0; fi
          
          echo "Detected Passed Tests: $PASS_COUNT"
          
          # 4. Logic Baru: Lanjut jika Pass >= 2
          if [ "$PASS_COUNT" -ge 2 ]; then
            echo "âœ… Success condition met: $PASS_COUNT tests passed (>= 2 required)."
            exit 0
          else
            echo "âŒ Failed condition: Only $PASS_COUNT tests passed (less than 2)."
            exit 1
          fi
      
      # ============================================
      # ğŸ³ DOCKER DEPLOYMENT
      # ============================================
      
      - name: ğŸ³ Setup Docker
        run: |
          echo "ğŸ³ Runner-${{ matrix.runner }}: Setting up Docker..."
          docker network create dria-nodes 2>/dev/null || true
          docker pull firstbatch/dkn-compute-node:latest
          echo "âœ… Ready"
      
      - name: ğŸš€ Deploy Containers (Using Shared Wallets)
        id: deploy
        run: |
          echo "ğŸš€ Runner-${{ matrix.runner }}: Deploying containers..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          WALLET_FILE="wallets.json"
          ACTUAL_COUNT=$(jq '. | length' "$WALLET_FILE")
          TOTAL=$(( $ACTUAL_COUNT * $CONTAINERS_PER_WALLET ))
          
          echo "Runner-${{ matrix.runner }}: Deploying $TOTAL containers..."
          echo "Using $ACTUAL_COUNT wallets from SHARED $WALLET_FILE"
          echo "Using vLLM server: self-hosted (unlimited)"
          
          DKN_MODELS="${{ secrets.DKN_MODELS }}"
          [ -z "$DKN_MODELS" ] && DKN_MODELS="llama3.3:70b-instruct-q4_K_M"
          
          echo "Using model: $DKN_MODELS"
          
          STARTED=0
          
          for (( w=0; w<$ACTUAL_COUNT; w++ )); do
            ADDRESS=$(jq -r ".[$w].address" "$WALLET_FILE")
            PRIVKEY=$(jq -r ".[$w].private_key" "$WALLET_FILE")
            PRIVKEY="${PRIVKEY#0x}"
            ADDR_SHORT="${ADDRESS:2:6}"
            
            for (( i=1; i<=$CONTAINERS_PER_WALLET; i++ )); do
              NAME="r${{ matrix.runner }}_w$((w+1))_${ADDR_SHORT}_$(printf '%03d' $i)"
              
              docker ps -aq -f name="^${NAME}$" | xargs -r docker rm -f > /dev/null 2>&1
              
              if docker run -d \
                --name "$NAME" \
                --network dria-nodes \
                --restart on-failure:3 \
                -e DKN_WALLET_SECRET_KEY="$PRIVKEY" \
                -e DKN_MODELS="$DKN_MODELS" \
                -e OLLAMA_HOST="http://host.docker.internal" \
                -e OLLAMA_PORT="$PROXY_PORT" \
                -e OLLAMA_AUTO_PULL="false" \
                --add-host host.docker.internal:host-gateway \
                firstbatch/dkn-compute-node:latest > /dev/null 2>&1; then
                STARTED=$((STARTED + 1))
              fi
              
              if (( STARTED % $BATCH_SIZE == 0 )); then
                echo "Runner-${{ matrix.runner }} Progress: $STARTED/$TOTAL"
                sleep $PAUSE_SECONDS
              fi
            done
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Runner-${{ matrix.runner }}: Deployed $STARTED containers"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "started=$STARTED" >> $GITHUB_OUTPUT
      
      # ============================================
      # ğŸ“± SEND DEPLOYMENT TO MONITOR
      # ============================================
      
      - name: ğŸ“Š Send Deployment to Monitor
        if: success()
        continue-on-error: true
        env:
          MONITOR_VPS_URL: 'http://208.76.40.194:1155'
          MONITOR_API_KEY: 'dkn-monitor-secret-key-12345'
        run: |
          echo "ğŸ“Š Runner-${{ matrix.runner }}: Sending deployment data to monitor..."
          
          WALLET_FILE="wallets.json"
          FIRST_WALLET=$(jq -r '.[0].address' "$WALLET_FILE")
          GITHUB_USER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          
          curl -X POST "$MONITOR_VPS_URL/api/deployed" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $MONITOR_API_KEY" \
            -d "{
              \"github_user\": \"$GITHUB_USER\",
              \"repository\": \"${{ github.repository }}\",
              \"run_id\": \"${{ github.run_id }}\",
              \"runner_id\": ${{ matrix.runner }},
              \"wallet\": \"$FIRST_WALLET\",
              \"containers\": ${{ steps.deploy.outputs.started }},
              \"backend\": \"vllm-selfhosted\",
              \"status\": \"deployed\"
            }" || echo "âš ï¸ Monitor notification failed (non-critical)"
          
          echo "âœ… Deployment data sent"


      - name: ğŸ“± Send Deployment Success Notification Telegram
        if: success()
        env:
          BOT_TOKEN: '8378781421:AAEEMC7AIFzpbcK6P_MM5E1d-weQ73J_Wr4'
          CHAT_ID: '-1001377822481'
          TOPIC_ID: '15'
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "âš ï¸  Telegram not configured, skipping"
            exit 0
          fi
          
          echo "ğŸ“± Runner-${{ matrix.runner }}: Sending deployment notification to Topic ID: $TOPIC_ID..."
          
          WALLET_FILE="wallets.json"
          WALLET_COUNT=$(jq '. | length' "$WALLET_FILE")
          FIRST_WALLET=$(jq -r '.[0].address' "$WALLET_FILE")
          
          RUNNING=$(docker ps --filter "name=r${{ matrix.runner }}_" --filter "status=running" | wc -l)
          RUNNING=$((RUNNING - 1))
          TOTAL=$(docker ps -a --filter "name=r${{ matrix.runner }}_" | wc -l)
          TOTAL=$((TOTAL - 1))
          
          if [ "$TOTAL" -gt 0 ]; then
            SUCCESS_RATE=$(( RUNNING * 100 / TOTAL ))
          else
            SUCCESS_RATE=0
          fi
          
          TRIGGER="${{ github.event_name }}"
          if [ "$TRIGGER" = "schedule" ]; then
            TRIGGER_TEXT="Auto-Schedule"
          else
            TRIGGER_TEXT="Manual"
          fi
          
          GITHUB_USER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO_URL="https://github.com/${{ github.repository }}"
          
          MESSAGE="ğŸš€ *Runner-${{ matrix.runner }} Deployed!*

          ğŸ³ Containers: \`$RUNNING/$TOTAL\` ($SUCCESS_RATE%)
          ğŸ’° Wallets: \`$WALLET_COUNT\` (SHARED across all runners)
          ğŸ–¥ï¸  Backend: \`vLLM Self-Hosted\` (unlimited)
          ğŸ“ First: \`${FIRST_WALLET:0:10}...${FIRST_WALLET: -8}\`
          ğŸ”„ Trigger: $TRIGGER_TEXT
          ğŸ“¦ Repo: $REPO_URL
          #ï¸âƒ£ Run: \`#${{ github.run_number }}\`

          â±ï¸ Runtime: $RUNTIME_HOURS hours
          ğŸ”— [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          echo "ğŸ“¤ Sending message to Topic $TOPIC_ID..."
          SEND_MSG=$(curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d message_thread_id="${TOPIC_ID}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true \
            -d text="$MESSAGE")
          
          MSG_OK=$(echo "$SEND_MSG" | jq -r '.ok')
          if [ "$MSG_OK" = "true" ]; then
            echo "âœ… Message sent to Topic $TOPIC_ID (NO file upload)"
          else
            ERROR=$(echo "$SEND_MSG" | jq -r '.description')
            echo "âŒ Failed to send message: $ERROR"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment notification completed"

          
      # ============================================
      # â° RUNTIME WITH MONITORING
      # ============================================
      
      - name: â° Runtime Period with Live Monitoring
        env:
          MONITOR_VPS_URL: 'http://208.76.40.194:1155'
          MONITOR_API_KEY: 'dkn-monitor-secret-key-12345'
        run: |
          echo "â° Runner-${{ matrix.runner }}: Starting runtime with monitoring..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          RUNTIME_SEC=$(echo "$RUNTIME_HOURS * 3600" | bc | cut -d. -f1)
          START=$(date +%s)
          END=$((START + RUNTIME_SEC))
          
          WALLET_FILE="wallets.json"
          FIRST_WALLET=$(jq -r '.[0].address' "$WALLET_FILE")
          GITHUB_USER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          
          # Monitor VPS endpoint
          MONITOR_URL="$MONITOR_VPS_URL/api/heartbeat"
          
          echo "Runtime: $RUNTIME_HOURS hours"
          echo "Start: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Monitor: $MONITOR_URL"
          echo ""
          
          HEARTBEAT_COUNT=0
          NEXT_HEARTBEAT=$START
          
          while [ $(date +%s) -lt $END ]; do
            CURRENT=$(date +%s)
            ELAPSED=$((CURRENT - START))
            REMAINING=$((END - CURRENT))
            
            # Kirim heartbeat setiap 5 menit (300 detik)
            if [ $CURRENT -ge $NEXT_HEARTBEAT ]; then
              HEARTBEAT_COUNT=$((HEARTBEAT_COUNT + 1))
              
              # Hitung container status
              RUNNING=$(docker ps --filter "name=r${{ matrix.runner }}_" --filter "status=running" -q 2>/dev/null | wc -l)
              TOTAL=$(docker ps -a --filter "name=r${{ matrix.runner }}_" -q 2>/dev/null | wc -l)
              
              echo "ğŸ’“ Heartbeat #$HEARTBEAT_COUNT: Containers $RUNNING/$TOTAL | Elapsed: $((ELAPSED/60))m | Remaining: $((REMAINING/60))m"
              
              curl -X POST "$MONITOR_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $MONITOR_API_KEY" \
                -d "{
                  \"github_user\": \"$GITHUB_USER\",
                  \"repository\": \"${{ github.repository }}\",
                  \"run_id\": \"${{ github.run_id }}\",
                  \"run_number\": ${{ github.run_number }},
                  \"runner_id\": ${{ matrix.runner }},
                  \"wallet\": \"$FIRST_WALLET\",
                  \"containers_running\": $RUNNING,
                  \"containers_total\": $TOTAL,
                  \"backend\": \"vllm-selfhosted\",
                  \"uptime_seconds\": $ELAPSED,
                  \"status\": \"running\",
                  \"timestamp\": \"$(date -u '+%Y-%m-%dT%H:%M:%SZ')\"
                }" > /dev/null 2>&1 || echo "âš ï¸ Heartbeat failed (non-critical)"
              
              # Set next heartbeat time (5 menit dari sekarang)
              NEXT_HEARTBEAT=$((CURRENT + 300))
            fi
            
            # Sleep 60 detik
            sleep 60
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Runner-${{ matrix.runner }}: Runtime completed"
          echo "ğŸ“Š Total heartbeats sent: $HEARTBEAT_COUNT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ============================================
      # ğŸ›‘ SHUTDOWN
      # ============================================
      
      - name: ğŸ›‘ Shutdown
        if: always()
        run: |
          echo "ğŸ›‘ Runner-${{ matrix.runner }}: Shutting down..."
          
          docker ps -q -f name=r${{ matrix.runner }}_ | xargs -r docker stop -t 10
          docker ps -aq -f name=r${{ matrix.runner }}_ | xargs -r docker rm -f
          docker network rm dria-nodes 2>/dev/null || true
          [ -f proxy/proxy.pid ] && kill $(cat proxy/proxy.pid) 2>/dev/null || true
          
          echo "âœ… Cleaned up"
      
      # ============================================
      # ğŸ“¦ ARTIFACTS
      # ============================================
      
      - name: ğŸ“¦ Save Logs to Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-runner-${{ matrix.runner }}-${{ github.run_id }}
          path: proxy/proxy.log
          retention-days: 7
          if-no-files-found: warn
      
      # ============================================
      # ğŸ“± TELEGRAM NOTIFICATION (FAILURE ONLY)
      # ============================================
      
      - name: ğŸ“± Send Failure Notification
        if: failure()
        env:
          BOT_TOKEN: '8378781421:AAEEMC7AIFzpbcK6P_MM5E1d-weQ73J_Wr4'
          CHAT_ID: '-1001377822481'
          TOPIC_ID: '19'
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            exit 0
          fi
          
          echo "ğŸ“± Runner-${{ matrix.runner }}: Sending failure notification to Topic ID: $TOPIC_ID..."
          
          REPO_URL="https://github.com/${{ github.repository }}"
          CURRENT_TIME=$(date -u '+%Y-%m-%d %H:%M UTC')
          
          TRIGGER="${{ github.event_name }}"
          if [ "$TRIGGER" = "schedule" ]; then
            TRIGGER_TEXT="Auto"
          else
            TRIGGER_TEXT="Manual"
          fi
          
          MESSAGE="ğŸš¨ *Runner-${{ matrix.runner }} ERROR!*

          *STATUS*
          â”œâ”€ State: Failed
          â”œâ”€ Exit Code: 1
          â””â”€ Duration: Check logs

          *CONTEXT*
          â”œâ”€ Repo: $REPO_URL
          â”œâ”€ Run: \`#${{ github.run_number }}\`
          â”œâ”€ Trigger: $TRIGGER_TEXT
          â””â”€ Time: $CURRENT_TIME

          *ACTION REQUIRED*
          â””â”€ Check logs for details

          ğŸ” [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d message_thread_id="${TOPIC_ID}" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=true \
            -d text="$MESSAGE" > /dev/null
          
          echo "âœ… Failure notification sent to Topic $TOPIC_ID"

  # ============================================
  # ğŸ“Š SUMMARY JOB
  # ============================================
  
  summary:
    name: ğŸ“Š Summary Report
    runs-on: ubuntu-latest
    needs: runtime
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        env:
          BOT_TOKEN: '8378781421:AAEEMC7AIFzpbcK6P_MM5E1d-weQ73J_Wr4'
          CHAT_ID: '-1001377822481'
          TOPIC_ID: '17'
          ALL_KEYS: ${{ secrets.NOVITA_API_KEYS }}
        run: |
          echo "ğŸ“Š Generating summary report..."
          
          TOTAL_RUNNERS=5
          SHARED_WALLETS=160
          CONTAINERS_PER_WALLET=4
          TOTAL_CONTAINERS=$(( SHARED_WALLETS * CONTAINERS_PER_WALLET * TOTAL_RUNNERS ))
          
          
          if [ -n "$BOT_TOKEN" ] && [ -n "$CHAT_ID" ]; then
            echo "ğŸ“± Sending summary to Topic ID: $TOPIC_ID..."
            
            MESSAGE="ğŸ“Š *ALL RUNNERS COMPLETE!*

            âœ… Status: All $TOTAL_RUNNERS runners finished
            ğŸ³ Total Containers: \`$TOTAL_CONTAINERS\`
            â±ï¸ Runtime: \`5.5 hours\`
            #ï¸âƒ£ Run: \`#${{ github.run_number }}\`

            ğŸ“ Wallet File:
            â””â”€ wallets.json ($SHARED_WALLETS wallets, SHARED)

            ğŸ‰ Mission accomplished!

            ğŸ”— [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d message_thread_id="${TOPIC_ID}" \
              -d parse_mode="Markdown" \
              -d disable_web_page_preview=true \
              -d text="$MESSAGE" > /dev/null
            
            echo "âœ… Summary sent to Topic $TOPIC_ID"
          fi
          
          echo "âœ… Summary complete"
